-- ROTA --
local otobusMarker = 0
local otobusCreatedMarkers = {}
local otobusRota = {

	
	{ 1253.6767578125,-1383.8388671875,13.32044506073, false },
	{ 1220.7724609375,-1398.5439453125,13.338366508484, false },
	{ 1132.4951171875,-1393.6455078125,13.635469436646, false },
	{ 1030.96875,-1393.1455078125,13.378349304199, false },
	{ 906.201171875,-1393.1083984375,13.391505241394, false },
	{ 824.17578125,-1392.705078125,13.509308815002, false },
	{ 736.1875,-1392.9140625,13.585726737976, false },
	{ 648.52734375,-1391.677734375,13.643135070801, false },
	{ 634.9775390625,-1349.3759765625,13.538529396057, false },
	{ 635.0322265625,-1271.201171875,16.738130569458, false },
	{ 630.9560546875,-1189.2998046875,18.562391281128, false },
	{ 576.642578125,-1132.6240234375,26.286012649536, false },
	{ 448.76171875,-1113.126953125,27.841747283936, false },
	{ 329.0947265625,-1137.404296875,24.126436233521, false },
	{ 212.09375,-1183.0400390625,18.799983978271, false },
	{ 116.826171875,-1234.3935546875,15.293343544006, false },
	{ 60.60546875,-1271.404296875,14.317496299744, false },
	{ -8.12109375,-1325.6884765625,11.280584335327, false },
	{ -57.6357421875,-1366.408203125,11.638847351074, false },
	{ -121.7490234375,-1428.59375,12.907542228699, false },
	{ -193.671875,-1508.07421875,14.223861694336, false },
	{ -255.748046875,-1589.8583984375,16.011430740356, false },
	{-297.00390625,-1679.775390625,14.987861633301, false },
	{ -340.794921875,-1801.6318359375,19.45200920105, false },
	{ -374.9296875,-1964.736328125,28.296747207642, false },
	{ -344.1513671875,-2145.458984375,28.544780731201, false },
	{ -251.32421875,-2338.689453125,31.238527297974, false },
	{ -178.15234375,-2410.6826171875,35.537868499756, false },
	{ -42.0888671875,-2596.109375,43.80005645752, false },
	{ -97.7373046875,-2800.828125,38.849872589111, false },
	{ -262.107421875,-2812.0947265625,51.310409545898, false },
	{ -429.9990234375,-2767.61328125,66.587387084961, false },
	{ -606.5966796875,-2746.2529296875,67.802757263184, false },
	{ -729.0966796875,-2756.5029296875,74.259895324707, false },
	{ -916.1787109375,-2835.220703125,69.894172668457, false },
	{ -1130.3505859375,-2849.0390625,67.870498657227, false },
	{ -1327.673828125,-2872.18359375,56.982578277588, false },
	{ -1492.810546875,-2822.3544921875,46.636074066162, false },
	{ -1633.650390625,-2719.451171875,49.103382110596, false },
	{ -1807.623046875,-2571.048828125,56.76505279541, false },
	{ -1929.90234375,-2590.4072265625,61.288757324219, false },
	{ -2096.85546875,-2638.60546875,53.504306793213, false },
	{-2250.87109375,-2620.154296875,48.189212799072, false },
	{-2456.0927734375,-2396.826171875,31.473642349243, false },
	{ -2504.4140625,-2214.0205078125,28.924764633179, false },
	{ -2541.08203125,-2131.87109375,31.96895980835, false },
	{-2656.8828125,-2040.2919921875,42.012523651123, false },
	{-2800.5595703125,-1933.1083984375,45.802665710449, false },
	{ -2881.5771484375,-1764.66796875,29.863275527954, false },
	{ -2925.1748046875,-1504.77734375,10.845135688782, false },
	{ -2915.44921875,-1264.9599609375,10.623021125793, false },
	{ -2858.80078125,-906.8974609375,9.3664112091064, false },
	{ -2845.0625,-608.515625,7.1884641647339, false },
	{ -2741.5009765625,-440.78125,7.3627777099609, false },
	{ -2564.7470703125,-349.76171875,24.084613800049, false },
	{ -2310.7890625,-348.1181640625,39.996402740479, false },
	{-2079.3212890625,-349.8095703125,35.458686828613, false },
	{ -1978.5244140625,-350.3466796875,38.962539672852, false },
	{ -1865.57421875,-206.466796875,44.285717010498, false },
	{ -1887.2587890625,-3.98828125,38.394207000732, false },
	{-1871.15234375,129.3525390625,38.37878036499, false },
	{ -1842.0322265625,264.279296875,28.736238479614, false },
	{-1791.916015625,348.4521484375,16.332780838013, false },
	{ -1766.0234375,322.7509765625,7.7351865768433, false },
	{ -1760.6474609375,297.8046875,7.4884924888611, false },
	{ -1807.92578125,238.80078125,15.111549377441, false },
	{ -1810.5126953125,124.75390625,15.112842559814, false },
	{ -1802.193359375,-34.6005859375,15.236112594604, false },
	{ -1807.9375,-113.71875,5.649875164032, false },
	{ -1875.7158203125,-110.8779296875,12.537831306458, false },
	{ -1926.27734375,-66.416015625,25.70551109314, false },
	{ -1974.6396484375,-64.08203125,27.947156906128, false },
	{ -2021.2197265625,-68.3193359375,35.317085266113, false },
	{ -2048.998046875,-83.234375,35.316299438477, false },
	{ -2053.2451171875,-122.345703125,35.438919067383, false },
	{ -2072.2177734375,-189.50390625,35.466239929199, false },
	
	{ -2078.55859375,-221.7421875,35.470268249512, true },
	
	{ -2056.4892578125,-201.537109375,35.473670959473, false },
	{ -2043.671875,-160.216796875,35.476921081543, false },
	{ -2043.0537109375,-117.3359375,35.368412017822, false }, --1
	{ -2064.8955078125,-68.4677734375,35.32186126709, false },
	{ -2083.4951171875,-58.501953125,35.382610321045, false },
	{ -2085.0185546875,10.533203125,35.32727432251, false },
	{-2104.6728515625,46.7744140625,35.31335067749, false },
	{-2130.1533203125,110.9306640625,35.320465087891, false },
	{ -2150.2939453125,124.3681640625,35.317874908447, false },
	{ -2144.4892578125,188.8212890625,35.350757598877, false },
	{ -2144.8544921875,266.470703125,35.322345733643, false },
	{ -2144.490234375,347.8759765625,35.320133209229, false },
	{-2141.0595703125,473.126953125,35.162841796875, false },
	{-2138.86328125,540.361328125,35.162883758545, false },
	{-2138.873046875,588.1669921875,39.029823303223, false },
	{ -2138.9814453125,687.5498046875,64.252540588379, false },
	{ -2139.5966796875,779.0517578125,69.564819335938, false },
	{ -2139.169921875,888.2265625,80.023498535156, false },
	{ -2137.5732421875,1039.0498046875,80.004951477051, false },
	{-2160.27734375,1095.908203125,79.991004943848, false },
	{ -2252.537109375,1103.2392578125,79.677017211914, false },
	{ -2252.931640625,1194.4306640625,55.350929260254, false },
	{ -2250.599609375,1258.7119140625,42.04838180542, false },
	{ -2098.568359375,1262.76171875,16.001129150391, false },
	{ -2058.6953125,1314.296875,7.2520508766174, false },
	{ -2241.8935546875,1335.8310546875,7.185703754425, false },
	{ -2393.6396484375,1381.609375,7.218065738678, false },
	{ -2457.8544921875,1359.3271484375,7.191662311554, false },
	{ -2458.123046875,1228.7685546875,35.205528259277, false },

	
	{ -2509.6787109375,1205.3671875,37.572002410889, true },
	

	{ -2498.830078125,1190.615234375,38.830890655518, false },
	{ -2596.39453125,1210.1474609375,51.331897735596, false },
	{ -2665.48046875,1222.77734375,55.574821472168, false },
	{ -2671.6083984375,1337.4697265625,55.583923339844, false },
	{ -2671.447265625,1517.0068359375,59.609825134277, false },
	{ -2670.9326171875,1820.52734375,67.803070068359, false },
	{ -2738.8857421875,2389.9921875,72.986778259277, false },
	{ -2621.3310546875,2598.0439453125,70.040657043457, false },
	{ -2305.0283203125,2635.3583984375,54.768005371094, false },
	{ -2143.90625,2628.9248046875,55.858497619629, false },
	{ -1991.78125,2551.8623046875,55.526737213135, false },
	{ -1840.59375,2226.4208984375,19.728384017944, false },
	{ -1670.9599609375,2086.0986328125,18.559572219849, false },
	{ -1668.5263671875,2022.5830078125,18.907253265381, false },
	{ -1706.03515625,1824.7451171875,25.009059906006, false },
	{ -1779.876953125,1906.146484375,15.674780845642, false },
	{ -1792.1201171875,2076.306640625,8.7554502487183, false },
	{-1810.3232421875,2137.021484375,7.4114117622375, false },
	{ -1710.865234375,2271.7197265625,13.526606559753, false },
	{-1609.7626953125,2405.2236328125,55.566745758057, false },
	{-1577.638671875,2596.5087890625,66.602012634277, false },
	{-1628.3466796875,2683.8330078125,54.871528625488, false },
	{ -1618.521484375,2721.658203125,57.919563293457, false },
	{ -1472.4423828125,2726.3994140625,65.966003417969, false },
	{ -1352.76171875,2669.51171875,51.060676574707, false },

	
	{ -1292.4794921875,2714.6220703125,50.213020324707, true },

	{ -1241.0380859375,2676.900390625,47.263751983643, false },
	{ -1055.166015625,2702.861328125,46.018669128418, false },
	{ -917.23046875,2718.6669921875,46.018657684326, false },
	{ -693.36328125,2732.1630859375,53.237010955811, false },
	{ -518.1943359375,2712.0390625,66.192726135254, false },
	{ -331.9736328125,2636.111328125,63.93871307373, false },
	{ -75.26171875,2634.2216796875,64.030578613281, false },
	{ 139.76953125,2731.68359375,54.089694976807, false },
	{ 353.7294921875,2709.9111328125,60.621726989746, false },
	{ 506.2060546875,2717.794921875,66.678939819336, false },
	{ 663.7490234375,2706.380859375,60.537296295166, false },
	{ 878.259765625,2661.02734375,30.061550140381, false },
	{ 849.6103515625,2498.75,29.753660202026, false },
	{ 766.4208984375,2345.65625,28.381006240845, false },
	{ 673.529296875,2433.2041015625,32.032405853271, false },
	{ 773.041015625,2616.013671875,17.458751678467, false },
	{ 926.3896484375,2582.1474609375,10.550038337708, false },
	{ 1171.890625,2418.7470703125,11.017181396484, false },
	{ 1316.4326171875,2373.189453125,11.700211524963, false },
	{ 1457.6943359375,2449.93359375,6.886492729187, false },
	{ 1602.013671875,2451.6357421875,6.9779868125916, false },
	{ 1775.845703125,2475.443359375,6.9797825813293, false },
	{ 2013.1630859375,2541.5927734375,6.9495477676392, false },
	{ 2260.484375,2601.189453125,6.9070639610291, false },
	{ 2519.4755859375,2578.501953125,5.0108976364136, false },
	{ 2691.6484375,2376.4697265625,6.8870186805725, false },
	{ 2689.8671875,2226.154296875,6.8439521789551, false },
	{ 2641.0224609375,2150.8271484375,10.556827545166, false },
	{ 2660.7421875,2110.3681640625,11.052415847778, false },
	{ 2817.3544921875,2111.203125,10.81333732605, false },
	{ 2850.7119140625,2130.693359375,10.816334724426, false },
	{ 2849.767578125,2234.955078125,10.82772731781, false },
	{ 2862.6337890625,2290.8125,10.82147693634, false }, --2
	{ 2910.4765625,2313.8623046875,10.81849861145, false },
	{2910.7861328125,2404.966796875,10.885572433472, false },

	{ 2883.013671875,2440.3955078125,10.977575302124, true },

	{2904.853515625,2419.302734375,10.9688539505, false },
	{ 2905.396484375,2332.1484375,10.825440406799, false },
	{ 2874.203125,2295.6103515625,10.826929092407, false },
	{ 2844.2216796875,2270.0009765625,10.804661750793, false }, --1
	{ 2844.9794921875,2164.7880859375,10.822622299194, false },
	{2835.0810546875,2115.71875,10.841814994812, false },
	{ 2758.111328125,2115.7548828125,12.187921524048, false },
	{2637.0048828125,2095.7138671875,10.807611465454, false },
	{2696.4609375,1990.2158203125,6.8783373832703, false },
	{ 2706.056640625,1823.6455078125,6.8872861862183, false },
	{2705.83203125,1574.4853515625,6.8880214691162, false },
	{2706.349609375,1371.8662109375,6.8886151313782, false },
	{2702.203125,1085.90625,6.8808860778809, false },
	{2599.0615234375,909.0732421875,6.8902974128723, false },
	{2485.208984375,859.39453125,6.8861455917358, false },
	{2236.2666015625,854.79296875,6.8830418586731, false },
	{ 2009.56640625,855.0263671875,6.8852458000183, false },
	{1858.6806640625,849.833984375,9.4779071807861, false },
	{1791.955078125,812.4931640625,11.04222202301, false },
	{1778.1044921875,689.2626953125,16.254493713379, false },
	{1730.45703125,515.0947265625,28.651704788208, false },
	{ 1684.90234375,388.15625,30.332799911499, false },
	{1624.2373046875,239.3896484375,30.34300994873, false },
	{ 1598.544921875,292.333984375,20.785125732422, false },
	{ 1772.3046875,254.55078125,19.067049026489, false },
	{1988.6162109375,291.572265625,34.151119232178, false },
	{2266.568359375,302.1962890625,32.813426971436, false },
	{2341.1494140625,257.1669921875,26.484735488892, false },
	{2341.388671875,112.5244140625,26.496250152588, false },
	
	{ 2459.330078125,-33.9716796875,26.632350921631, true },	

	{2481.853515625,-10.74609375,26.48193359375, false },
	{2536.98046875,6.3505859375,26.482442855835, false },
	{ 2556.27734375,39.3662109375,26.491430282593, false },
	{2705.279296875,27.7197265625,24.62770652771, false },
	{ 2749.3974609375,-90.1923828125,35.179962158203, false },
	{2872.25390625,-588.82421875,11.568780899048, false },
	{ 2871.5078125,-857.64453125,11.026251792908, false },
	{2868.1982421875,-1172.5009765625,11.031434059143, false },
	{ 2901.3193359375,-1484.3935546875,11.025501251221, false },
	{ 2844.955078125,-1693.9189453125,11.023554801941, false },
	{2820.85546875,-1920.9775390625,11.08487033844, false },
	{ 2813.16796875,-2092.7890625,11.085580825806, false },
	{ 2690.392578125,-2153.7001953125,11.073761940002, false },
	{ 2473.5673828125,-2153.390625,13.682097434998, false },
	{ 2286.03515625,-2248.34375,13.58345413208, false },
	{2226.8662109375,-2190.49609375,13.48422908783, false },
	{2173.78515625,-2138.2255859375,13.50612449646, false },
	{ 2083.0029296875,-2107.6806640625,13.498232841492, false },
	{1959.994140625,-2123.634765625,13.529898643494, false },
	
	{ 1940.857421875,-2146.4306640625,13.70579624176, true },	


	{1964.150390625,-2134.166015625,13.528615951538, false },
	{1963.8857421875,-2038.9130859375,13.532987594604, false },
	{1964.310546875,-1916.2890625,13.540146827698, false },
	{1964.5693359375,-1800.2197265625,13.531736373901, false },
	{1954.166015625,-1751.2451171875,13.529118537903, false },
	{ 1862.705078125,-1749.9775390625,13.542353630066, false },
	{1803.08203125,-1729.8017578125,13.537747383118, false },
	{1723.3671875,-1730.4765625,13.533897399902, false },
	{1576.2861328125,-1730.9189453125,13.539308547974, false },
	{1410.6474609375,-1729.96875,13.539875984192, false },
	{1315.5458984375,-1722.0556640625,13.53099155426, false },
	{1314.4453125,-1607.0419921875,13.531320571899, false },
	{1324.708984375,-1524.158203125,13.539527893066, false },
	{ 1354.6259765625,-1462.927734375,13.531158447266, false },
	{1359.8369140625,-1361.5595703125,13.552340507507, false },
	{1332.1318359375,-1278.443359375,13.531710624695, false },
	{1253.453125,-1294.7021484375,13.488011360168, false },

	{ 1244.50390625,-1344.2978515625,13.418493270874, true, true }
}

function otobusBasla(cmd)
	if not getElementData(getLocalPlayer(), "otobusSoforlugu") then
		local oyuncuArac = getPedOccupiedVehicle(getLocalPlayer())
		local oyuncuAracModel = getElementModel(oyuncuArac)
		local kacakciAracModel = 437
		
		if oyuncuAracModel == kacakciAracModel then
			setElementData(getLocalPlayer(), "otobusSoforlugu", true)
			updateotobusRota()
			addEventHandler("onClientMarkerHit", resourceRoot, otobusRotaMarkerHit)
		end
	else
		outputChatBox("[!] #FFFFFFZaten mesleğe başladınız!", 255, 0, 0, true)
	end
end
addCommandHandler("otobusbasla", otobusBasla)

function updateotobusRota()
	otobusMarker = otobusMarker + 1
	for i,v in ipairs(otobusRota) do
		if i == otobusMarker then
			if not v[4] == true then
				local rotaMarker = createMarker(v[1], v[2], v[3], "checkpoint", 4, 255, 0, 0, 255)
				table.insert(otobusCreatedMarkers, { rotaMarker, false })
			elseif v[4] == true and v[5] == true then 
				local bitMarker = createMarker(v[1], v[2], v[3], "checkpoint", 4, 255, 255, 0, 255)
				table.insert(otobusCreatedMarkers, { bitMarker, true, true })	
			elseif v[4] == true then
				local malMarker = createMarker(v[1], v[2], v[3], "checkpoint", 4, 255, 255, 0, 255)
				table.insert(otobusCreatedMarkers, { malMarker, true, false })			
			end
		end
	end
end

function otobusRotaMarkerHit(hitPlayer, matchingDimension)
	if hitPlayer == getLocalPlayer() then
		local hitVehicle = getPedOccupiedVehicle(hitPlayer)
		if hitVehicle then
			local hitVehicleModel = getElementModel(hitVehicle)
			if hitVehicleModel == 437 then
				for _, marker in ipairs(otobusCreatedMarkers) do
					if source == marker[1] and matchingDimension then
						if marker[2] == false then
							destroyElement(source)
							updateotobusRota()
						elseif marker[2] == true and marker[3] == true then
							local hitVehicle = getPedOccupiedVehicle(hitPlayer)
							setElementFrozen(hitVehicle, true)
							setElementFrozen(hitPlayer, true)
							toggleAllControls(false, true, false)
							otobusMarker = 0
							triggerServerEvent("otobusParaVer", hitPlayer, hitPlayer)
							outputChatBox("[!] #FFFFFFRing tamamlanmıştır. Eğer devam etmek istemiyorsanız, /otobusbitir yazınız.", 0, 0, 255, true)
							setTimer(
								function(thePlayer, hitVehicle, hitMarker)
									destroyElement(hitMarker)
									setElementFrozen(hitVehicle, false)
									setElementFrozen(thePlayer, false)
									toggleAllControls(true)
									updateotobusRota()
								end, 100, 1, hitPlayer, hitVehicle, source
							)	
						elseif marker[2] == true and marker[3] == false then
							local hitVehicle = getPedOccupiedVehicle(hitPlayer)
							setElementFrozen(hitPlayer, true)
							setElementFrozen(hitVehicle, true)
							toggleAllControls(false, true, false)
							outputChatBox("[!] #FFFFFFYolcular iniyor, lütfen bekleyiniz.", 0, 0, 255, true)
							setTimer(
								function(thePlayer, hitVehicle, hitMarker)
									destroyElement(hitMarker)
									outputChatBox("[!] #FFFFFFYolcular inmiştir, yola devam edebilirsiniz.", 0, 255, 0, true)
									setElementFrozen(hitVehicle, false)
									setElementFrozen(thePlayer, false)
									toggleAllControls(true)
									updateotobusRota()
								end, 12000, 1, hitPlayer, hitVehicle, source
							)						
						end
					end
				end
			end
		end
	end
end

function otobusBitir()
	local pedVeh = getPedOccupiedVehicle(getLocalPlayer())
	local pedVehModel = getElementModel(pedVeh)
	local otobusSoforlugu = getElementData(getLocalPlayer(), "otobusSoforlugu")
	if pedVeh then
		if pedVehModel == 437 then
			if otobusSoforlugu then
				exports.global:fadeToBlack()
				setElementData(getLocalPlayer(), "otobusSoforlugu", false)
				for i,v in ipairs(otobusCreatedMarkers) do
					destroyElement(v[1])
				end
				otobusCreatedMarkers = {}
				otobusMarker = 0
				triggerServerEvent("otobusBitir", getLocalPlayer(), getLocalPlayer())
				removeEventHandler("onClientMarkerHit", resourceRoot, otobusRotaMarkerHit)
				removeEventHandler("onClientVehicleStartEnter", getRootElement(), otobusAntiYabanci)
				setTimer(function() exports.global:fadeFromBlack() end, 2000, 1)
			end
		end
	end
end
addCommandHandler("otobusbitir", otobusBitir)

function otobusAntiYabanci(thePlayer, seat, door) 
	local vehicleModel = getElementModel(source)
	local vehicleJob = getElementData(source, "job")
	local playerJob = getElementData(thePlayer, "job")
	
	if vehicleModel == 437 and vehicleJob == 3 then
		if thePlayer == getLocalPlayer() and seat ~= 0 then
			setElementFrozen(thePlayer, true)
			setElementFrozen(thePlayer, false)
			outputChatBox("[!] #FFFFFFMeslek aracına binemezsiniz.", 255, 0, 0, true)
		elseif thePlayer == getLocalPlayer() and playerJob ~= 11 then
			setElementFrozen(thePlayer, true)
			setElementFrozen(thePlayer, false)
			outputChatBox("[!] #FFFFFFBu araca binmek için otobus Şoförlüğü mesleğinde olmanız gerekmektedir.", 255, 0, 0, true)
		end
	end
end
addEventHandler("onClientVehicleStartEnter", getRootElement(), otobusAntiYabanci)

function otobusAntiAracTerketme(thePlayer, seat)
	if thePlayer == getLocalPlayer() then
		local theVehicle = source
		if seat == 0 then
			otobusBitir()
		end
	end
end
addEventHandler("onClientVehicleStartExit", getRootElement(), otobusAntiAracTerketme)

function otobusBlip()
	blip = createBlip(2213.9912109375, -2650.8603515625, 13.54687, 0, 4, 255, 255, 0)  --0 0 1787.1259765625 -1903.591796875 13.394536972046
	exports.hud:sendBottomNotification(localPlayer, "otobus Şoförü", "Haritadaki sarı işarete giderek otobus şoförlüğü mesleğinize başlayabilirsiniz.")
end